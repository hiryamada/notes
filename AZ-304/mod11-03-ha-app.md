# 高可用性アプリケーション設計


geo 冗長性を使用して高可用性アプリケーションを設計する
https://docs.microsoft.com/ja-jp/azure/storage/common/geo-redundant-design


ここでは、ストレージアカウントにデータを読み書きするアプリケーションを想定している。

```
アプリケーション
↓
ストレージアカウントのエンドポイント
↓
ストレージアカウント
```

■ストレージアカウント

冗長化オプション:
- GRS / RA-GRS
  - ローカル冗長ストレージ (LRS) を使用してプライマリ リージョンで 3 回同期的にレプリケートされた後、セカンダリ リージョンに非同期的にレプリケート
  - 地域的な障害が発生した場合でも、データの高可用性を確保
    - 例: 東日本リージョン（プライマリ）＋西日本リージョン（セカンダリ）でGRSを構成した場合
      - 東日本リージョンの、データが格納されているデータセンターに障害が発生すると、読み書きが不能となる
- GZRS / RA-GZRS
  - ゾーン冗長ストレージ (ZRS) を使用してプライマリ リージョンの 3 つの Azure 可用性ゾーン間で同期的にレプリケートされた後、セカンダリ リージョンに非同期的にレプリケート
  - 最大の可用性を必要とするアプリケーション向け
    - 例: 東日本リージョン（プライマリ）＋西日本リージョン（セカンダリ）でGRSを構成した場合
      - 東日本リージョンの、データが格納されているデータセンター（またはその可用性ゾーン）に障害が発生しても、別の可用性ゾーンが無事であれば、読み書きが可能

エンドポイント:
- GRS/GZRS
  - プライマリエンドポイント
    - 読み書き可能
  - セカンダリエンドポイント
    - **利用できない**
- RA-GRS/RA-GZRS
  - プライマリエンドポイント
    - 読み書き可能
  - セカンダリエンドポイント
    - **読み込み可能**

■RA-GRSでの運用例

平常時: アプリケーションは「読み書き」モードで運用

```
                  アプリケーション
                  ↓             
    プライマリエンドポイント(rw)  セカンダリエンドポイント(r)
                  ↓             
プライマリリージョン         セカンダリリージョン
└データ ------------------> └データ
           レプリケーション
```

プライマリリージョンでの障害発生時:アプリケーションを「読み取り専用」のモードで運用
- アプリケーションは、セカンダリエンドポイントを使用して、データの読み取りだけを実行できる

```
                  アプリケーション
                                ↓
    プライマリエンドポイント(rw)  セカンダリエンドポイント(r)
                                ↓
プライマリリージョン（障害）      セカンダリリージョン
└データ                         └データ
```

フェールオーバーを実行し、フェールオーバーが完了: アプリケーションは「読み書き」モードで運用。
- 読み書きを行うためのプライマリエンドポイントのアドレスは変わらない
- ストレージアカウントの冗長性は「LRS」となる。
  - セカンダリエンドポイントはなくなる

```
                  アプリケーション
                  ↓          
    プライマリエンドポイント(rw)  
                            ↓   
プライマリリージョン（障害）  セカンダリリージョン
                            └データ
```

■アプリケーションの設計例

- プライマリリージョンに障害が発生した場合
  - アプリケーションを「読み取り専用」のモードで運用
  - セカンダリリージョンのエンドポイントを使用してデータを読み取る
  - [「読み取り専用」のモードで、アプリケーションに書き込みが行われようとした場合の対応例](https://docs.microsoft.com/ja-jp/azure/storage/common/geo-redundant-design?tabs=current#handling-updates-when-running-in-read-only-mode)
    - 書き込みが現在できない旨をユーザーに通知する（エラーメッセージを表示する）
    - 書き込み要求をキューに保存する。障害が解消したら、キューに保存された書き込み要求を順に処理する
    - （プライマリ・セカンダリとは別の、第3の）リージョンのストレージアカウントに一時的に書き込む。障害が解消したら、一時的に書き込まれたデータをプライマリに反映させる。
