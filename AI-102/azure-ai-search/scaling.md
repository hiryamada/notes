# Azure AI Searchのスケーリング

リソースの作成時、または作成後に、パーティション数やレプリカ数を調節できる。

![Alt text](../image-5.png)

■パーティション

インデックスを分散配置する物理ストレージ。1パーティション＝25GB。

複数のパーティションを使って読み取り/書き込み操作を分散させることでパフォーマンスが向上する。

また、複数のパーティションを使うことで最大ストレージ容量が増える。

- 1, 2, 3, 4, 6, 12個から選択
- Free、Basicでは1個のみ。Standard以上（S3HDを除く）は最大12。S3HDは最大3。

■レプリカ

ワークロードを分散させ、可用性とパフォーマンスを高めるしくみ。

https://learn.microsoft.com/ja-jp/azure/search/search-reliability#high-availability

https://learn.microsoft.com/ja-jp/azure/search/search-reliability#availability-zone-support

- レプリカはインデックスのコピー。
- 最低1
- 最大1（Free）、3（Basic）、12（Standard以上）
- レプリカが2個以上ある場合は、クエリについて 99.9% の可用性が保証される。
- レプリカが3個以上ある場合は、クエリとインデックス作成について 99.9% の可用性が保証される。
- Standard以上の場合、可用性ゾーンに対応するリージョンでは、各レプリカは自動的に複数の可用性ゾーンに分散配置される。

https://learn.microsoft.com/ja-jp/azure/search/search-capacity-planning#estimate-with-a-billable-tier

レプリカを追加するとパフォーマンスが向上する。ただし、厳密に線形に向上するわけではなく、たとえば 3 つのレプリカを追加しても、スループットが 3 倍になるとは限らない。

■検索ユニット (Search Unit または Scale Unit, SU)

レプリカまたはパーティションのいずれかとして割り当てられている請求単位。

検索ユニット数＝レプリカ数 ✕ パーティション数。

たとえば2レプリカ、2パーティションの場合、4検索ユニットが割り当てられるため、1検索ユニットを使用する場合に比べて4倍の料金がかかる。

参考: 東日本リージョン、Standard S1で、SUあたりの価格は $0.45/時間（$324.12/月）。

■シャード

インデックスのチャンク（塊）。

1つのインデックスは内部的に複数の「シャード」から構成される。

これはAzure AI Searchの内部的な仕組みであり、ユーザーが構成することはできない。

たとえばシャード数の指定、シャードの配置の指定、シャードの移動などをユーザーがコントロールすることはできない。

例: 2つのパーティションがあり、あるインデックスが8シャードで構成されている場合

```
パーティション1
└検索ユニット1
 └シャード1,2,3,4

パーティション2
└検索ユニット2
 └シャード5,6,7,8
```

