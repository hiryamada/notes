# ラボ7

想定時間: 60分

ストレージアカウントの各種設定を学習します。

（まだ準備していない場合）事前に[ラボのファイル](https://github.com/MicrosoftLearning/AZ-104JA-MicrosoftAzureAdministrator/archive/master.zip)をダウンロードして展開しておきましょう。

## ラボの重要ポイント

- タスク1
  - ARMテンプレートを使用してVMをデプロイします
- タスク2
  - ストレージアカウントを作成します
    - アカウントの種類は汎用v1とします
    - レプリケーションはRA-GRSとします。
  - 汎用v1から汎用v2にアップグレードします
  - ストレージアカウントに、プライマリとセカンダリのエンドポイントがあることを確認します。
  - レプリケーションをGRSに変更します。
    - ストレージアカウントに、プライマリのエンドポイントだけががあることを確認します。
  - レプリケーションをLRSに変更します。
    - ストレージアカウントに、プライマリのエンドポイントだけががあることを確認します。
  - デフォルトのBlobアクセス層を「クール」に変更します。
    - これにより、GBあたりの保存コストは「ホット」よりも低くなります。
- タスク3
  - Blobコンテナーを作成します。「非公開 (匿名アクセスなし)」 に設定します。
  - ファイルをアップロードします。
- タスク4
  - コンテナーの設定が「非公開 (匿名アクセスなし)」 のため、BlobのデフォルトのURLでは、インターネットからのBlobへの匿名アクセスができないことを確認します。
  - BlobのSAS URLを生成し、そのURLでは匿名アクセスができることを確認します。
  - 認証方法を「Azure AD ユーザー アカウント」に設定します。
  - **この設定により、ストレージアカウントへのアクセスの際の認証が、Azure ADユーザー＋RBACロールとなります。適切なRBACロールが割り当てられていないため、アクセスができなくなります。**
  - ユーザーに「ストレージBLOBデータ所有者」RBACロールを割り当てます。
  - 適切なRBACロールが割り当てられたので、再びアクセスができるようになります。
- タスク5
  - Azure portalで「ファイル共有」を作成します。
  - vm0にて、この「ファイル共有」をZ:ドライブとしてマウントします。
  - vm0で、Z:ドライブにフォルダとファイルを作成します。
  - Azure portalで「ファイル共有」を確認し、フォルダとファイルが作成されていることを確認します。
- タスク6
  - ストレージアカウントのネットワーク設定を「選択されたネットワーク」に変更します。
  - 「クライアントIPアドレス」（＝Azure portalに接続するためにみなさんが使用している送信元のグローバルIPアドレス）を追加します。
  - ローカルのブラウザから、SAS URLにアクセスができることを確認します。
  - Cloud Shellから、コマンドを使って、SAS URLにアクセスし、アクセスが失敗することを確認します。これは、Cloud Shellの環境がAzure上で実行されており、そのリクエストの送信元IPアドレスが、上記で許可した「クライアントIPアドレス」ではないためです。

## 補足事項

タスク2の15
クールにしたら保存してください。

タスク3の2
非公開→プライベート

タスク3の5
詳細セクション→詳細設定セクション
フォルダーへのアップロード→アップロード先のフォルダー

タスク4の5
アクセス許可Read→読み取り

タスク4の7
BLOB SAS URLは直後のタスクだけではなく最後のタスクでも使います。
メモ帳で残しておいてください。

タスク4の8
注意の通り、IEで見ると表示されますが、他のブラウザはダウンロードが始まります。

タスク4の13
Role→役割

タスク5の7
コマンドの実行→実行コマンド

タスク5の8
貼り付けはCtrl+vでお願いします。