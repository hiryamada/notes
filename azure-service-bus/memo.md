<!--

Service Bus FIFO
■セッション

Service Bus キューまたはサブスクリプションでのメッセージ処理において FIFO 処理を保証するには、セッションを使用します。


■Service Bus 価格レベル

Service Bus の Basic レベルはセッションをサポートしていません。 Standard レベルと Premium レベルはセッションをサポートしています。 これらのレベルの違いについては、「Service Bus の価格」を参照してください。

■メッセージにセッションIDを設定する

セッションに固有のアプリケーション定義の識別子にセッション ID のプロパティを設定することで、どのセンダーでも、メッセージをトピックまたはキューに送信するときにセッションを作成できます。 AMQP 1.0 プロトコル レベルでは、この値は group-id プロパティに相当します。

var message = new Message(Encoding.UTF8.GetBytes("Hello, Service Bus!"));
message.SessionId = "mySession";
await sender.SendAsync(message);

■セッション内のメッセージの順番

通常、アプリケーションでは関連するメッセージの開始および終了は明確に認識されます。 Service Bus では、特定の規則は設定されていません。 たとえば、アプリケーションでは、最初のメッセージの Label プロパティを start に、中間メッセージの場合であれば content に、最後のメッセージであれば end に設定できます。 

コンテンツ メッセージの相対位置は、現在のメッセージの SequenceNumber と start メッセージの SequenceNumber との差分として計算できます。

■セッションの有効化

キューまたはサブスクリプションでセッションが有効になっている場合、クライアント アプリケーションでは通常のメッセージを送受信 "できなくなります"。 すべてのメッセージは、(セッション ID を設定して) セッションの一部として送信し、セッションを受信することで受信する必要があります。

■セッションの有効期限はない（無期限）

セッション対応のキューまたはサブスクリプションでは、セッション ID を持つメッセージが 1 つ以上ある場合にセッションが生成されます。 1 度生成されたセッションの有効期限や存続期間、および API は定義されていません。 理論上は、メッセージを今日のセッションで受信して、次のメッセージを 1 年後に受信したとしても、セッション ID が一致する限り、Service Bus の観点からすると同じセッションになります。

■多重化（multiplexing）

高速あるいは広帯域のデータ伝送路で多くのより低速なデータを同時に送ること. これにより,伝送路を有効利用しコストを大幅に下げることができる

多重化（たじゅうか、英: multiplexing, muxing）とは電気通信およびコンピュータネットワークにおいて、複数のアナログ信号またはデジタルデータストリームをまとめ、一つの共有された伝送路で送ることである。多重通信、多重伝送とも言う。高価・貴重な資源を共有することを目的としている。例えば電気通信において、無線LANのアクセスポイントは、複数の端末が同時に接続し、1つの伝送路を共有して利用することができる。

```
a--->
b--->    a+b+c ===>
c--->
```
■逆多重化（de-multiplexing）

```
           a--->
a+b+c===>  b--->
           c--->
```

■セッションは、先入れ先出し (FIFO) および要求 - 応答のパターンで使用できます。

先入れ先出し (FIFO)パターン

■要求 - 応答パターン （request-response-pattern）

要求 - 応答パターンを使用すると、送信側アプリケーションから要求が送信され、受信側から送信側アプリケーションへの応答の正しい送信手段が提供されます。

https://learn.microsoft.com/ja-jp/azure/service-bus-messaging/service-bus-messaging-overview#message-sessions

送信側
↓要求
受信側

https://learn.microsoft.com/ja-jp/azure/service-bus-messaging/message-sessions#request-response-pattern

要求 - 応答パターンは、適切に確立された統合パターンであり、

送信側アプリケーションから要求を送信でき、

受信側が送信側アプリケーションに応答を正しく送信する手段を提供します。 

このパターンには、通常、アプリケーションからの応答の送信先となる、有効期間が短いキューまたはトピックが必要です。 
このシナリオでは、セッションは、同等のセマンティクスを持つ単純な代替ソリューションを提供します。

送信側アプリケーションを一意に識別するように特定のヘッダー パラメーターを設定することにより、複数のアプリケーションが 1 つの要求キューに要求を送信できます。 

受信側アプリケーションは、キューに入ってくる要求を処理し、セッション対応のキューで応答を送信して、送信側が要求メッセージで送信した一意識別子にセッション ID を設定します。 

要求を送信したアプリケーションは、特定のセッション ID でメッセージを受信し、応答を正しく処理することができます。

https://www.enterpriseintegrationpatterns.com/patterns/messaging/RequestReply.html


-->