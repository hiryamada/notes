# メッセージング（キュー）

■「キュー」「メッセージ」とはなにか？ なぜ使うのか？
  - 「キュー」: 「メッセージ」をためておく場所
  - 基本的に、メッセージはキューに到着順にたまり、先に到着したものから取り出される ※FIFO
  - メッセージを送受信するアプリ・システム等を「コンポーネント」と呼ぶ
    - 送信側は「プロデューサー」とも
    - 受信側は「コンシューマー」とも
  - コンポーネント間を「キュー」でつなぐ
  - 負荷分散
  - [負荷平準化](https://docs.microsoft.com/ja-jp/azure/architecture/patterns/queue-based-load-leveling)
  - 送信側・受信側は、相手の状態を気にしなくてよい（メンテナンス、障害対応等で有利）
  - 送信側・受信側は、相手のアドレスを知らなくてよい（構成の変更に強い）
  - タイトカップリング（tight coupling、密結合）→ルーズカップリング（loose coupling、疎結合）

■ [Azure Service Bus](https://docs.microsoft.com/ja-jp/azure/service-bus-messaging/service-bus-messaging-overview) - 高度な機能
  - 「FIFO」をサポートしている
  - 「At-Most-Once」の配信保証
  - 最大キューサイズ 80 GB
  - 最大メッセージサイズ 100 MB ※Premiumの場合
  - ノンブロッキング受信・ブロッキング受信をサポート

■ [Azure Queue Storage](https://docs.microsoft.com/ja-jp/azure/storage/queues/storage-queues-introduction) - シンプル
  - 「FIFO」をサポートしていない
  - 「At-Least-Once」の配信
  - 最大キューサイズ 500 TB
  - 最大メッセージサイズ 64 KB
  - ノンブロッキング受信のみ

※ノンブロッキング受信: キューに新しいメッセージがない場合、レスポンスがすぐに返される。

```
キュー（空）
↑受信リクエスト ↓レスポンス
クライアント
```

ノンブロッキングのキューに対して受信処理をループで繰り返し実行する場合、キューが空の場合に、短時間に空読みを繰り返すことが発生する。それを避けるため、ループにウェイト（待ち時間）を入れるといった工夫が必要。

※ブロッキング受信: ロングポーリングとも。キューに新しいメッセージがない場合、新しいメッセージが到着するまでブロックされ（待ち状態となり）、すぐにはレスポンスが返されない。待ち状態の間にキューにメッセージが到着した場合は、その瞬間にレスポンスが返される。

```
キュー（空）
↑受信リクエスト（メッセージが来るまで待ち状態となる）
クライアント
```

ノンブロッキングのキューに対して受信処理をループで繰り返し実行する場合は、ループにウェイト（待ち時間）を入れるといった工夫はいらない。
