
Azure Storage ファイアウォールおよび仮想ネットワークを構成する
https://docs.microsoft.com/ja-jp/azure/storage/common/storage-network-security

ストレージ アカウントへのネットワークアクセスの設定
- すべてのネットワークから接続できるようにする
- インターネットの特定のIPアドレスから接続できるようにする
- VNetの特定のサブネットから接続できるようにする
  - パブリックエンドポイント
  - プライベートエンドポイント

■すべてのネットワークから接続できるようにする

※ストレージアカウントのデフォルト設定。

VNetの設定:
- ストレージアカウント＞セキュリティとネットワーク＞ネットワーク
- 「許可するアクセス元」で「すべてのネットワーク」を選択

■インターネットの特定のIPアドレスから接続できるようにする

「Azure Storage ファイアウォール規則」を使用。


VNetの設定:
- ストレージアカウント＞セキュリティとネットワーク＞ネットワーク
- 「許可するアクセス元」で「選択されたネットワーク」を選択
- 「ファイアウォール」の「アドレス範囲」で、許可する接続元を指定
  - IPアドレス または アドレス範囲（CIDRで指定）
  - 複数可能

■VNetの特定のサブネットから接続できるようにする(1)

「サービスエンドポイント」を使用。

2018/4/19 一般提供開始。 https://azure.microsoft.com/ja-jp/updates/vnet-service-endpoints-for-storage/

```
VNet(選択したサブネット)
↓ サービスエンドポイント
ストレージアカウント
```

VNetの設定:
- 「サービスエンドポイント」を追加する
  - サービス: Microsoft.Storage
  - サブネット: 許可する接続元サブネットを指定（複数可能）

ストレージアカウントの設定:
- ストレージアカウント＞セキュリティとネットワーク＞ネットワーク
- 「許可するアクセス元」で「選択されたネットワーク」を選択
- 「＋既存の仮想ネットワークを追加する」
- VNetとサブネット（複数可能）を選択

備考:

https://docs.microsoft.com/ja-jp/azure/storage/common/storage-network-security

**一般に**、サービス エンドポイントは、同じ Azure リージョン内の仮想ネットワークとサービス インスタンスの間で機能する。

```
VNet 東日本
↓ サービスエンドポイント
サービス 東日本
```

**サービス エンドポイントを Azure Storage と共に使用すると**、この範囲はペアのリージョンを含むように拡張される。

```
VNet 東日本
↓サービスエンドポイント
ストレージアカウント(東日本)

VNet 東日本
↓サービスエンドポイント
ストレージアカウント(西日本)
```

許可するサブネットは、同じサブスクリプション内の VNet に属していても、または異なる Azure AD テナントに属するサブスクリプションなど、異なるサブスクリプション内のものであってもよい。

```
VNet テナント1のサブスクリプション1
↓サービスエンドポイント
ストレージアカウント テナント1のサブスクリプション1

VNet テナント1のサブスクリプション2
↓サービスエンドポイント
ストレージアカウント テナント1のサブスクリプション1

VNet テナント2のサブスクリプション3
↓サービスエンドポイント
ストレージアカウント テナント1のサブスクリプション1
```

■VNetの特定のサブネットから接続できるようにする(2)

プライベートエンドポイント(プライベートリンク)を使用。

概要:
https://docs.microsoft.com/ja-jp/azure/storage/common/storage-private-endpoints

2020/2/14 プライベートリンクの一般提供開始
https://azure.microsoft.com/en-us/updates/private-link-now-available-in-ga/

2020/3/16 Azure Storage等へのプライベートリンクの一般提供開始
https://azure.microsoft.com/en-us/updates/privatelinkforpaasga/

チュートリアル:
https://docs.microsoft.com/ja-jp/azure/private-link/tutorial-private-endpoint-storage-portal


プライベート エンドポイントとストレージ サービス間の接続では、セキュリティで保護されたプライベート リンクが使用される。

プライベート リンクのトラフィックは、Microsoft のバックボーン ネットワークを経由する（インターネットを流れない）。

```
VNet
└サブネット
  └ プライベート エンドポイント
    ↓プライベートリンク
ストレージアカウント
```

プライベートエンドポイントは特別な種類のNIC。読み取り専用。サブネットのプライベートIPアドレスが割り当てされる。

```
VNet
└サブネット 10.0.0.0/24
  └ プライベート エンドポイント(NIC) 10.0.0.0/4
```

ストレージアカウントに接続する場合は「対象サブリソース」で「blob」「table」などを選択する。選択したリソースにのみ接続できる。

```
VNet
└サブネット
  └ プライベート エンドポイント(対象サブリソース: blob)
    ↓プライベートリンク
ストレージアカウント
├ Blob 接続可
├ Files 接続不可
├ Table 接続不可
└ Queue 接続不可
```

プライベート エンドポイントの作成に伴い、プライベートDNSゾーンが同時に作成される。

```
プライベートDNSゾーン
↑リンク
VNet
└サブネット
  └ プライベート エンドポイント
    ↓プライベートリンク
ストレージアカウント
```

ストレージアカウントのエンドポイントの名前解決を行うと、プライベートエンドポイントのIPアドレスが返される。

```
VNet
└サブネット
  ├ VM example.blob.core.windows.net -> プライベートエンドポイントのIPアドレス
  └ プライベート エンドポイント(NIC)
    ↓プライベートリンク
ストレージアカウント example.blob.core.windows.net

```

プライベートエンドポイントの作成:
- ストレージアカウント＞セキュリティとネットワーク＞ネットワーク＞プライベートエンドポイント接続＞＋プライベートエンドポイント
- 名前と地域（リージョン）を指定
- 「対象サブリソース」で「blob」等を選択
- 仮想ネットワークとサブネットを選択

備考:

サブネットにNSGが関連付けられていても、サブネット内のプライベートエンドポイントには無効となる。

```
VNet
 └ サブネット
   ├ NSG
   └ プライベートエンドポイント (NSGが適用されない)
```
プライベート エンドポイントが存在するリージョンは仮想ネットワークと同じでなければならないが、接続しようとしているプライベート リンク リソースのリージョンとは異なっていても構わない。

```
VNet(東日本)
 └ サブネット
   ├ NSG
   └ プライベートエンドポイント(東日本)
    ↓プライベートリンク
ストレージアカウント(任意のリージョン)
```

