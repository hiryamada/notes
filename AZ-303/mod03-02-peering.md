# 仮想ネットワークピアリング

https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-network-peering-overview

- 2つのVNetの接続機能。
- 各VNet内部のVMなどは相互に通信が可能となる。
- リージョン内のVNetを接続することも、異なるリージョンのVNetを接続することもできる。
- トラフィックはMicrosoftのプライベートなネットワークを介してルーティングされる。
  - トラフィックの暗号化を行う必要がない。
- ピアリングの作成に際してダウンタイムは発生しない
- 別の Azure サブスクリプションに属するVNetともピアリングできる
- 別テナントの Azure サブスクリプションに属するVNetともピアリングできる

注意
- 2つのVNetが重複するアドレス空間を持つ場合はピアリングできない
- ピアリングの作成には料金はかからないが、ピアリング経由のデータ転送には料金がかかる。

■ピアリングの種類

- （ローカル）仮想ネットワークピアリング
  - リージョン内でのピアリング
  - 例: 東日本←→東日本
- グローバル仮想ネットワークピアリング
  - 異なるリージョン間でのピアリング
  - 例: 東日本←→西日本
  - Microsoftのバックボーンインフラストラクチャを使用

制限
- グローバルピアリングを経由して、BasicロードバランサーのフロントエンドIP経由で、背後のリソースに接続することはできない。
- API Management等、内部的にBasicロードバランサーを使用している場合がある。
  - https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-faq#what-are-the-constraints-related-to-global-vnet-peering-and-load-balancers
- 制限を回避するためには、2つのVNetを、ピアリングではなく、VPNで接続する。

```
VNet1 東日本

↓ ピアリング

VNet2 西日本

フロントエンドIP
Basic LB
|   | 
VM  VM ... 東日本からフロントエンドIP経由ではつながらない
```

■ピアリングリンク

2つのVNet (たとえばVNet1とVNet2) を接続するピアリングは、2つの「リンク」で構成される。
- VNet1からVNet2へのピアリングリンク
- VNet2からVNet1へのピアリングリンク

リンクの状態
- 開始済み - リンクを1つ作成した状態
- 接続済み - リンクを2つ作成してピアリングがつながった状態
- 削除済み - リンクの片方を削除した状態. 再度ピアリングするにはいったん削除。

■推移性

ピアリングによる推移的な接続はサポートされない。

例1: 以下のような構成で、VNet1とVNet3は通信することができない。

```
VNet1
|ピアリング
VNet2
|ピアリング
VNet3
```

もし必要であれば、VNet1とVNet3もピアリングする必要がある。

例2: 以下のような構成であれば、ルーターを経由して、VNet1とVNet3が通信することができる。

```
VNet1
|ピアリング
VNet2: ルーター役のVM(NVA)をデプロイ
|ピアリング
VNet3
```

この場合は、追加でルートテーブルの設定も必要。

- VNet1に関連付けたルートテーブルで、VNet3へのトラフィックをルーターへと転送する
- VNet3に関連付けたルートテーブルで、VNet1へのトラフィックをルーターへと転送する

■ゲートウェイ トランジット（ゲートウェイ転送）

https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-peering-gateway-transit

- オンプレミスネットワークへの推移的な接続を設定することができる。
- ピアリング先の仮想ネットワークゲートウェイを使用してオンプレミスに接続する。

```
VNet1
|ピアリング
VNet2: 仮想ネットワークゲートウェイ
|VPN
オンプレミス
```

ピアリングの設定: 
- VNet1からVNet2へのピアリングリンクの設定: 
  - 「リモート仮想ネットワークのゲートウェイを使用する」にチェック
- VNet2からVNet1へのピアリングリンクの設定: 
  - 「この仮想ネットワークのゲートウェイを使用する」にチェック

■ルーティング

https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview

AzureのVNetにおけるトラフィックは、サブネットに関連付けられる「ルートテーブル」の「ルート」によってルーティングされる。

VM内のOSレベルのルート設定は不要。

■ルートテーブル

Azureには2種類の「ルート テーブル」がある。
- 「（自動で作成される）ルートテーブル」
- 「（ユーザーが作成する）ルートテーブル」

ルートテーブルには複数の「ルート」が追加される。

```
ルートテーブル
├ルート1
├ルート2
└ルート3
```

■ルート

ルートは「アドレス プレフィックス」と「ネクストホップ」（ルーティング先）で構成される。

- 例1: 100.0.0.0/8 → 1.2.3.4
- 例2: 0.0.0.0/0 → インターネット
- 例3: 10.0.0.0/8 → なし

■ルートが選択されるしくみ

2つのルールでルートが選択される。

**ルール1**: 送信トラフィックがサブネットから送信されると、Azure は「最長プレフィックス一致アルゴリズム」を使用して、宛先 IP アドレスに基づいて、ルートを選択する。

※ルートの定義順に判定されるわけではないので注意。

例:

- ルート1: 10.0.0.0/24 → 1.2.3.4
- ルート2: 10.0.0.0/16 → 5.6.7.8

/24 と /16 では、/24 のほうがプレフィックスが長い。

「10.0.0.5」あてのトラフィック: ルート1とルート2が該当するが、プレフィックスが長いルート1が選択される。

「10.0.1.5」あてのトラフィック: ルート2だけが該当し、ルート2が選択される。

たとえ:

- 東京都品川区 → 品川配送センター
- 東京都 → 東京配送センター

「東京都品川区大井1-2-3」は「品川配送センター」が選択される

「東京都港区江南4-5-6」は「東京配送センター」が選択される。

**ルール2**: 複数のルートに同じアドレス プレフィックスが含まれている場合は、次の優先順位に基づいてルートの種類が選択される。

1. ユーザー定義ルート(UDR) 
2. BGP のルート
3. システム ルート

例: 

- ルート1(UDR): 0.0.0.0/0 → 仮想ネットワークゲートウェイ
- ルート2(システムルート) 0.0.0.0/0 → インターネット

この場合、この2つのルールのプレフィックスはどちらも「/0」（同じ長さ）であるが、UDRのほうが優先順位が高いので、ルート1が選択される。

■ルートの種類

2種類の「ルート」がある。
- システム ルート
- カスタム ルート
  - ユーザー定義ルート（UDR）
    - プレフィックスとネクストホップを明示的に指定できる
    - システム ルートをオーバーライド（上書き）できる
  - BGPのルート
    - VPNや専用線(ExpressRoute)使用時に使われる
    - オンプレミスに向かうトラフィックを定義するルート
    - 設定
      - オンプレミスからアドバタイズされたプレフィックス
      - または「ローカルネットワークゲートウェイ」で構成されたプレフィックス

※BGPのルートは、[ドキュメント上「カスタム ルート」の一種として作成される](https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview#custom-routes)と記載があるが、実際には[「システム ルート」の一部として追加される](https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview#optional-default-routes)。

※「ローカルネットワークゲートウェイ」は、オンプレミス側のVPNルーターを表すAzureリソース。サイト対サイト（S2S）接続の際に利用する。オンプレミス側VPNルーターのIPアドレスや、オンプレミスのネットワークのアドレス範囲を指定する。

```
VPNゲートウェイ
| VPN接続
ローカルネットワークゲートウェイ
```

■（自動で作成される）ルートテーブル

- サブネットごとに「ルート テーブル」が自動的に作成される
- 規定の「システム ルート」が書き込まれる

```
サブネット
└（自動で生成される）ルートテーブル: システムルートが書き込まれる
```

■システム ルート

- システム ルートはユーザーが作成・削除・編集することはできない
  - カスタム ルートで「上書き」することができる
- デフォルトの「システムルート」
  - https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview#default
- 特定の機能を有効にすると、それに対応する規定のシステム ルートが追加される。
  - BGPのルートなど。
  - https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview#optional-default-routes

■（ユーザーが作成する）ルートテーブル

- オプション（必要な場合に作成）
- 「ユーザー定義ルート(UDR)」（後述）を追加できる
- サブネットに「関連付け」することで、（自動で作成される）ルートテーブルの「システム ルート」を **上書き** することができる。

```
サブネット
├（自動で生成される）ルートテーブル: システムルートが書き込まれる
└（ユーザーが作成する）ルートテーブル: 「ユーザー定義ルート(UDR)」を書き込む
```

■ユーザー定義ルート（User Defined Route: UDR）

https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview#user-defined

-（ユーザーが作成する）ルートテーブルに手動で追加するルートのこと。
- 仮想アプライアンスに向けるトラフィックを定義するルートなどを定義できる。

例: 
- 0.0.0.0/0 -> 10.20.30.40

# サービス チェイニング

https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-network-peering-overview#service-chaining

Azureにおける「サービス チェイニング」とは、ユーザー定義ルート（UDR）を使用して、仮想ネットワークのトラフィックを、ピアリングされたネットワーク内の仮想アプライアンス(NVA)やVPNゲートウェイに向けることを指す。

※Azure ExpressRoute ゲートウェイに向けることはできない。

例1: トラフィックを仮想アプライアンス(NVA)に向ける
```
VNet1 + ルートテーブル(ユーザー定義ルート)
|ピアリング
VNet2: NVA
```

例2: トラフィックをVPNゲートウェイに向ける
```
VNet1 + ルートテーブル(ユーザー定義ルート)
|ピアリング
VNet2: VPNゲートウェイ
|VPN
オンプレミス
```
