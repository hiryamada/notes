# Azure Storage 暗号化

※サーバー側暗号化 (SSE)とも

https://docs.microsoft.com/ja-jp/azure/storage/common/storage-service-encryption

Azure Storage（ストレージ アカウント）において、データがクラウドに永続化されるときに自動的・透過的に暗号化（復号）される。

■サービスレベルの暗号化

- すべてのストレージ アカウントで有効
- サーバー側暗号化 (SSE) を使用して、データがクラウドに永続化されるときに自動的に暗号化
- 256 ビット AES 暗号化を使用
- 無効にすることはできない
- コードまたはアプリケーションを変更する必要はない
- 追加コストはない
- 使用されるキー
  - Microsoft のマネージド キー	
    - 対象: すべて
    - キー管理: Microsoft キー ストア
    - 方法: デフォルトで設定済み
  - **カスタマー マネージド キー**
    - 対象: BLOBとFilesのみ
    - キー管理: 「Azure Key Vault」 または 「Azure Key Vault Managed HSM」に格納する必要がある
    - 方法: ストレージアカウントの「暗号化」で指定
  - カスタマー指定のキー
    - 対象: BLOBのみ
    - キー管理: 客様側の独自のキーストアで管理
    - 方法: [クライアントアプリのリクエストヘッダーでキーを指定](https://docs.microsoft.com/ja-jp/azure/storage/blobs/encryption-customer-provided-keys)

■インフラストラクチャレベルの暗号化

- インフラストラクチャ レベルで 256 ビットの AES 暗号化を有効にすることもできる
- 有効な場合、ストレージ アカウントのデータは、2 つの異なる暗号化アルゴリズムと 2 つの異なるキーを使用して、2 回暗号化される
  - サービス レベルで 1 回
  - インフラストラクチャ レベルで 1 回
- キー管理:
  - Microsoft マネージド キー
  - 常に別のキーが使用される
- 有効化方法
  - ストレージアカウント作成＞詳細設定＞インフラストラクチャ暗号化を有効にする 
    - デフォルトではチェックは付いていない
  - ストレージアカウントの**作成時**にインフラストラクチャ暗号化を使用するようにストレージ アカウントを構成する**必要がある**
  - ストレージ アカウントの**作成後**にインフラストラクチャ暗号化を有効または無効にすることは**できない**
  - 汎用v2のみ

■「サービスレベルの暗号化」でCMKを有効にする手順例1

**※Key Vaultのアクセスポリシーの「アクセス許可モデル」を「コンテナーのアクセス ポリシー」とする場合**

- Key Vaultを作成
  - アクセスポリシーはデフォルト（コンテナーのアクセス ポリシー）のまま
- キーを作成
- ストレージアカウントを作成
- ストレージアカウント＞暗号化＞暗号化の種類 で「カスタマー マネージド キー」を選択
- コンテナーとキーを選択

■「サービスレベルの暗号化」でCMKを有効にする手順例2

**※Key Vaultのアクセスポリシーの「アクセス許可モデル」を「Azure ロールベースのアクセス制御」とする場合**

- Key Vaultを作成
  - アクセスポリシーを「Azure ロールベースのアクセス制御」とする
  - 作成後、「アクセス制御（IAM）」で、自分自身（操作中のユーザー）に「キーコンテナー管理者」を割り当てる（キーを作成するため）
  - キーを作成する
- ストレージアカウントを作成する
- ストレージアカウントにマネージドIDを割り当てる
  - ※現在この操作はAzure portalからはできないもよう。
  - PowerShell: ` Set-AzStorageAccount -ResourceGroupName xxx -AccountName yyy -AssignIdentity` 
  - Azure CLI: `az storage account update -g xxx -n yyy --assign-identity`
- Key Vaultの「アクセス制御（IAM）」で、「キー コンテナー暗号化サービスの暗号化」ロールを、ストレージアカウントのマネージドIDに割り当てる
- ストレージアカウント＞暗号化＞暗号化の種類 で「カスタマー マネージド キー」を選択
- コンテナーとキーを選択して「保存」

