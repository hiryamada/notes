# ラボ5 Privileged Identity Management

目標: 120min

Azure AD Privileged Identity Managementの操作を体験します。

- 演習1 
  - aaduser2に、「課金管理者」「グローバル閲覧者」「セキュリティ管理者」の3つのAzure ADロールを割り当てます。
  - 「グローバル閲覧者」ロールの使用については、事前にaaduser3の承認が必要となるように設定します。
- 演習2 
  - aaduser2でAzure Portalにサインインし、3つのロールを「アクティブ化」します。「アクティブな割り当て」で確認すると、「グローバル閲覧者」ロールは、承認が必要なため、割り当てがアクティブ化されていないことが確認できます。
  - aaduser3ででAzure Portalにサインインし、aaduser2の「グローバル閲覧者」ロールの「アクティブ化」を承認します。
- 演習3 
  - ユーザーにロールが必要であることを確認する「アクセス レビュー」を実施します。
  - ロールのアクティブ化の履歴などを確認します。

# 事前準備

[ラボ4a](lab04a-mfa.md)で作成したテナント「AdatumLab500-04」を使用します。このテナントにはaaduser1/2/3というユーザーが作成済みです。

まだラボ4aを実施していない場合は、先にラボ4aの演習2のタスク1,2,3,4を実施してください。

途中で、aaduser2と、aaduser3のUPN(aaduser2@～～.onmicrosoft.com など)とパスワードが必要となります。これらが不明な場合は、Azure ADの画面でaaduser2/3を表示し、UPNをコピーします。パスワードは「パスワードのリセット」を行うことで、新しい一時パスワードを生成できます。

## 演習1

タスク1-2 検索ボックスに「pim」と入力すると Azure AD Privileged Identity Management が検索できます。

タスク1-4 「ロール」がグレーアウトしてクリックできない場合は、選択中のテナントが「AdatumLab500-04」であること、そのテナントでPremium P2試用版が有効化されていることを確認してください。

タスク1-9 「割り当ての種類」 が 「有資格」 に設定されていることを確認 → 「対象」が選択されていることを確認します。

ここでは「対象(Eligible)」 と 「アクティブ(Active)」が選択できます。デフォルト値は「対象」となっています。

- 「対象」割り当て: このロールのメンバーは、ロールを使用するにはアクション(MFAチェックなど)を実行する必要があります。
- 「アクティブ」割り当て: アクションは不要で、アクティブ割り当てされたメンバーは、ロールによって提供される特権を常に所有します。

参考: [Privileged Identity Management で Azure AD ロールを割り当てる](https://docs.microsoft.com/ja-jp/azure/active-directory/privileged-identity-management/pim-how-to-add-role-to-user?tabs=new)

タスク1-11 AdatumLab500-04 | 割り当て ブレードに戻り → Privileged Identity Management ＞ 管理 ＞ Azure ADロール ＞ 管理 ＞ 割り当て とたどります

タスク1-11 「適格な割り当て」 → 「資格のある割り当て」

タスク1-11 各タブを確認します → 「資格のある割り当て」には、課金管理者としてaaduser2が割り当てされていることを確認します。「アクティブな割り当て」では、グローバル管理者として、最初のユーザー（Microsoftアカウントの名前）と、aaduser1が割り当てされていることを確認します。

タスク2-6 「アクティブ化するには承認が必要」 チェック ボックス → 「アクティブにするには承認が必要です」チェックボックス


## 演習2

タスク1-1 InPrivate ブラウザーの画面を開きます。→ ブラウザーでCtrl + Shift + Nを押してこの画面を開きます。

タスク1-2 aaduser2 ユーザー アカウントを使用してサインインします。→ サインインすると「サインインの状態を維持しますか？」という質問が出る場合があります。「はい」を押して続行します。

タスク1-8 「理由」 テキスト ボックスに 、アクティブ化の理由を示すテキストを入力 → 例：「今月の課金額の確認のため」

タスク1-9 Azure portal にサインアウトして再度ログインします。→ ブラウザが自動的にリロードされます。再度のログイン（サインイン）は不要です。「ロールをアクティブ化しました」と表示されます。

タスク1-13 意図を確認します。→ （課金の確認といった、ロールを使った作業が終わったという仮定で）自ら非アクティブ化を行っています。

タスク2-1 InPrivate ブラウザー画面での Azure portal で、aaduser2 ユーザーとしてサインインしている間に、Privileged Identity Management に戻ります。 → InPrivateウィンドウ内で、Privileged Identity Management の画面へ移動します。

タスク2-2 「対象割り当て」 →「資格のある割り当て」

タスク2-4 「理由」 テキスト ボックスに 、アクティブ化の理由を示すテキストを入力 → 例：「今月の監査のため」

タスク2-7～2-8 「追加検証が必要です」が表示されない場合は、このタスクをスキップします。

タスク2-9 「理由」 テキスト ボックスに 、アクティブ化の理由を示すテキストを入力 → 例：「今月のセキュリティ管理作業のため」

タスク2-14 aaduser2 による グローバル閲覧者 ロールへのロールのアクティブ化要求を表すエントリ → このページを表示してから、一覧にエントリが表示されるまで、数十秒程度かかる場合がありますので、しばらく待ちます。

タスク2-16 「妥当性」 テキストボックスに、有効化の理由を入力 → 「理由」テキストボックスに「承認します」と入力します。

## 演習3

タスク1-1 自信のアカウントから Azure portal https://portal.azure.com/ にサインインします。→ InPrivateウィンドウを閉じ、元のウィンドウで操作を続けます。

タスク1-5/1-6 画面左のメニューの「管理」セクションの「アクセスレビュー」をクリックします。「タスク」セクションの「アクセスのレビュー」と間違えないでください。

タスク1-9 「グローバル閲覧者」 エントリをクリックします → このエントリが表示されない場合は、ブラウザでページをリロードしてください。

タスク1-10 「未確認」 カテゴリ→「未レビュー」カテゴリ

タスク1-13 「AdatumLab500-04 | アクセス レビュー」の画面に戻ります。（画面上部のリンク「AdatumLab500-04」をクリックします）

タスク1-14 画面左のメニューの「タスク」セクションの「アクセスのレビュー」をクリックします。「管理」セクションの「アクセスレビュー」と間違えないでください。続いて、画面右側の一覧に表示された「グローバル管理者のレビュー」行をクリックしてください。

タスク1-16 「理由」には「aaduser2の業務に必要なアクセスであることを確認しました」と入力します。


タスク2-2 「アラート」→「警告」

タスク2-3 例えば、「Eligible administrators aren't activating their privileged role」（資格がある管理者が特権ロールをアクティブ化していない）をクリックします。画面右側に「アラート設定の編集」が表示され、「ロールがアクティブ化されていない日数」が30日に設定されています。つまり、ロールをアクティブ化することができるユーザーが、30日間ロールをアクティブ化しなかった場合に、警告（アラート）が出される、という設定になっています。

タスク2-4 「AdatumLab500-04 | クイック スタート」画面に戻ります。「概要」をクリックします。
