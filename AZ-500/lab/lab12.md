# ラボ12

publicとprivateという2つのサブネットにそれぞれVMを起動します。ネットワークセキュリティグループ、サービスエンドポイント、ストレージアカウントの「選択されたネットワーク」を設定することで、以下の構成をつくります。

|サブネット|RDP接続|インターネット接続|ストレージアカウント接続|
|-|-|-|-|
|publicサブネット|可能|可能|不可能|
|privateサブネット|可能|不可能|可能|

このラボではリモートデスクトップ接続を使用します。

## 演習1

タスク1-4 リージョン：米国東部

タスク1-5 IPv4アドレス空間に「10.0.0.0/16」 が表示されている場合、サブネット名が「default」のサブネットにチェックを付けて「サブネットの削除」をクリックし、「＋サブネットの追加」をクリックし、サブネット名「public」、サブネットアドレス範囲「10.0.0.0/24」のサブネットを「追加」します。

IPv4アドレス空間に「10.0.0.0/16」 以外が表示されている場合、そのアドレスが表示されているテキストボックスをクリックして、入力されているアドレスを削除し、「10.0.0.0/16」 を入力します。サブネットが削除されるので、「＋サブネットの追加」をクリックし、サブネット名「public」、サブネットアドレス範囲「10.0.0.0/24」のサブネットを「追加」します。

タスク2-5 サブネット名: private

タスク3-1 「（クラシック）」が付かない「ネットワーク セキュリティ グループ」のほうを選択します。

タスク3-8 	ドロップダウン リストで、「サービス タグ」 を選択し、ストレージ をクリックします → Service Tag と Storage

タスク3-8 プロトコル 任意 → Any

送信セキュリティ規則の名前はあとから変更できません。名前を変更したい場合は、一旦その規則を削除します。


タスク3-16 サブネット プライベート → private

タスク4-3 場所： (US)米国東部

タスク4-13 テキストエリア（灰色）の右下にコピーボタンがあり、それをクリックしてコピーします。メモ帳などに貼り付けて記録しておきます。

タスク4-15 「選択したネットワーク」 オプションを選択 → 「選択されたネットワーク」

タスク4-16 プライベート→private

タスク5-3/5-9 すでに Windows サーバーのライセンスを持っています → 
既存の Windows Server ライセンスを使用しますか? の、チェックを付けない


タスク5-5 サブネット	非公開 → private

タスク5-5 パブリックIP (新規) mongodbserver-ip → 初期値のまま変更せずに進めます。

タスク5-11 サブネット 公開 → public

タスク5-5 パブリックIP (新規) myVmPublic-ip → 初期値のまま変更せずに進めます。

タスク6-2 myVMPrivate は、private ネットワークに配置されていますが、それに関連付けられたネットワークセキュリティグループでRDP接続が許可されており、VMにはパブリックIPが付与されているので、リモートデスクトップ接続が可能です。

タスク6-5 リモートデスクトップ接続したVMの画面の左下のWindowsマーク（スタートボタン）をクリックし、そのまま「ISE」と打ち込むと「Windows PowerShell ISE」が表示されます。

タスク6-6 前の手順でコピーしたスクリプトを、VM内で実行します。手順書に記載されたスクリプトは例ですので、これを貼り付けても動作しません。

貼り付けてエンターキーを押します。正しく実行されると下記のような出力が得られます。

```
CMDKEY: Credential added successfully.

Name           Used (GB)     Free (GB) Provider      Root                      
----           ---------     --------- --------      ----                      
Z                   0.00         10.00 FileSystem    \\st0921834725.file.cor...
```

タスク6-8 インターネットへの接続テストが失敗したことは以下の出力で確認できます。
```
TcpTestSucceeded       : False
```

タスク7-6 貼り付けてエンターキーを押します。実行されると下記のような出力が得られます。これは、ファイル共有（Z:）の接続ができなかったということを意味します。これは想定される結果です。

```
New-PSDrive : Access is denied
At line:6 char:5
+     New-PSDrive -Name Z -PSProvider FileSystem -Root "\\st0921834725. ...
+     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (Z:PSDriveInfo) [New-PSDrive], Win32Exception
    + FullyQualifiedErrorId : CouldNotMapNetworkDrive,Microsoft.PowerShell.Commands.NewPSDriveCommand
```

タスク7-7 出力の以下の部分より、接続が成功したことが確認できます。
```
TcpTestSucceeded : True
```

